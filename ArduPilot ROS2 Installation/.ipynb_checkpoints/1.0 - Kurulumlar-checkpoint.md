Kurulum aşamasında öncelikle Ubuntu 22.04 yüklü bir cihazın elinizde bulunması gerekmektedir. Dual boot seçeneği ile windows ile beraber ek bir işletim sistemi olarak kullanılabilmektedir. Kurulum aşamasında ilk aşamada ROS2 Humble kurulumu gerçekleştirilir daha sonrasında ArduPilot SITL paketlerinin ve simülasyon araçlarının kurulumu ile tamamlanır.


Kurulumlar için adımlar:

## 1. ROS2 Kurulumu
* https://docs.ros.org/en/humble/Installation/Ubuntu-Install-Debs.html
* Bu linkte ROS2 Humble için gerekli kurulum adımları açıklanmıştır. Öncelikle bu adımların takip edilerek tamamlanması gerekmektedir. ROS2 Humble Desktop Full sürümü kurulmalıdır.

## 2. ArduPilot SITL Kurulumu
### Gerekli Paketler
Kurulumların düzgün bir şekilde tamamlanabilmesi için bazı araçların kurulumu gerçekleştirilmelidir. Aşağıda bulunan adımlar takip edilmelidir.

```
sudo apt install python3-pip
sudo apt install python3-vcstool
sudo apt install python3-rosdep2
sudo apt install python3-dev libtool libffi-dev

```
### Mavproxy Kurulumu

```
pip3 install --user MAVProxy
export PATH=$PATH:~/.local/bin
```

### SITL Kurulumu
* https://ardupilot.org/dev/docs/ros2.html
* https://ardupilot.org/dev/docs/ros2-sitl.html 
Verilen iki linkteki adımlar sıra ile gerçekleştirilmelidir. İlk linkte bulunan ros2 workspace oluşturma adımlarında ardu_ws yerine ros2_ws ismini veya kendi tercih edeceğiniz başka bir ismi seçebilirsiniz. Bu durumda ardu_ws geçen komutların düzeltilmesi gerekmektedir.

İkinci adımda Ardupilot 4.5 seçeneği seçilerek adımlar uygulanmaya devam edilmelidir. Bu aşamanın ardından SITL kurulmuş olacaktır. 
### Source Adımları
ROS2 her yeni terminal açıldığında setup.bash dosyasının sourcelanmasını gerektirmektedir. Bu adımı sürekli tekrar etmek yerine ".bashrc" dosyasına komutlar eklenmelidir. Ayrıca oluşturulan ROS2 workspace için de benzer bir sourcelanma işlemi gerçekleştirilmektedir.

```
cd ~
gedit ~/.bashrc
# Açılan dosya içine aşağıdaki satırlar yapıştırılmalıdır.
# Oluşturduğunuz workspace ismini farklı bir şekilde belirlediyseniz "ros2_ws" kısmını bununla değiştirmelisiniz.
"""
source /opt/ros/humble/setup.bash
source ~/ros2_ws/install/setup.bash
"""
```

### Karşılaşılan Hatalar
* colcon build aşamasında 16 GB bellek yetersiz kalmaktadır. -> https://askubuntu.com/questions/178712/how-to-increase-swap-space bu link takip edilerek bellek için swap alanı arttırılarak bu sorun çözülmektedir, 8GB swap alanı uygun olacaktır.

## 3. Gazebo Harmonic Kurulumu
* https://ardupilot.org/dev/docs/ros2-gazebo.html : Bu linkteki adımlar takip edilerek ArduPilot SITL ile uyumlu şekilde simülasyon ortamının kurulumu gösterilmektedir. Gazebo Harmonic sürümü kurulmalıdır. 

### Gazebo Model Dosyalarınızı Oluşturmak
Gazebo ortamına kendi oluşturduğunuz modelleri ekleyebilmeniz için modelleri bulunduracağınız klasörü Gazebo'ya tanıtmanız gerekmektedir. Bunu bashrc dosyasına aşağıda bulunan satırları yapıştırarak gerçekleştirebilirsiniz.

```
export GZ_VERSION=harmonic
export GZ_SIM_RESOURCE_PATH=$GZ_SIM_RESOURCE_PATH:/home/$username/models
# /$username kısmına kendi kullanıcı adınızı girmeniz gerekmektedir.
```

## 4. MAVROS Kurulumu
Mavros kurulumu apt aracılığı ile kolay bir şekilde yapılabilir

```
sudo apt install -y python3-vcstool python3-rosinstall-generator python3-osrf-pycommon

# 1. Create the workspace: unneeded if you already has workspace
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws

# 2. Install MAVLink
#    we use the Kinetic reference for all ROS distros as it's not distro-specific and up to date
rosinstall_generator --format repos mavlink | tee /tmp/mavlink.repos

# 3. Install MAVROS: get source (upstream - released)
rosinstall_generator --format repos --upstream mavros | tee -a /tmp/mavros.repos
# alternative: latest source
# rosinstall_generator --format repos --upstream-development mavros | tee -a /tmp/mavros.repos
# For fetching all the dependencies into your ros2_ws, just add '--deps' to the above scripts
# ex: rosinstall_generator --format repos --upstream mavros --deps | tee -a /tmp/mavros.repos

# 4. Create workspace & deps
vcs import src < /tmp/mavlink.repos
vcs import src < /tmp/mavros.repos
rosdep install --from-paths src --ignore-src -y

# 5. Install GeographicLib datasets:
./src/mavros/mavros/scripts/install_geographiclib_datasets.sh

# 6. Build source
colcon build

# 7. Make sure that you use setup.bash or setup.zsh from workspace.
#    Else ros2 run can't find nodes from this workspace.
source install/setup.bash
```



## 5. MissionPlanner Kurulumu
MissionPlanner ArduPilot için bir yer kontrol istasyonudur. Sahip olduğu arayüz ile otopilotun modunu değişitirme, auto mode ile waypoint listesi hazırlayıp dronu başlatma, otopilot parametrelerini güncelleme, kalibrasyon gibi pek çok işlevi yerine getirmektedir ve kullanımı daha rahattır.

MissionPlanner ubuntuda resmi olarak desteklenmediği için mono kullanılarak çalıştırılmalıdır.
-> https://ardupilot.org/planner/docs/mission-planner-installation.html verilen bu linkte bu kurulumun ve çalıştırılmasının nasıl yapılacağı açıklanmıştır.


----

## Kurulumun Doğru Bir Şekilde Yapıldığını Doğrulama
Yapılan kurulumlardan sonra kurulumun başarılı olup olmadığını test etmek için aşağıdaki kod satırlarını kullanarak Gazebo Simülasyon ortamının, SITL'nin ve MAVROS kurulumlarının doğru bir şekilde yapılıp yapılmadığını kontrol edebilirsiniz.

```
ros2 launch ardupilot_gz_bringup iris_runway.launch.py
ros2 run mavros mavros_node --ros-args --param fcu_url:=udp://127.0.0.1:14551@14555
# Mavros adımında hata alırsanız SITL farklı bir porta çıkış vermektedir bu da genelde tcp:5760 portudur. Şu komutu deneyebilirsiniz.
ros2 run mavros mavros_node --ros-args --param fcu_url:=tcp://127.0.0.1:5760
```

MAVROS çalıştırıldıktan sonra:
```
ros2 topic list
# Burada /mavros/state topicinin bulunup bulunmadığını kontrol edebilirsiniz.
ros2 topic echo /mavros/state

# Bu komut çıktısında "connected: true" şeklinde gözüküyorsa kurulum başarılı bir şekilde tamamlanmıştır.
```

## Faydalı Linkler
  - [MAVLink][ml] -- The communication protocol for Drones, used by flight controllers, ground control stations, and peripherals
  - [mavlink\_ros][mlros] -- original ROS node (few messages, no proxy)
  - [Pixhawk][pixhawk] -- Open Standards for drone hardware
  - [PX4 Autopilot][px4] -- Flight Controller with support for most vehicle types and hardened/tested MAVROS support
  - [ArduPilot][apm] -- tested autopilot APM:Plane (default command set)
  - [QGroundControl][qgc] -- Ground Control Station for MAVLink autopilots, with tested support for Android, iOS, Mac OS, Linux, and Windows
  - [mavros\_extras][mrext] -- extra plugins & node for mavros